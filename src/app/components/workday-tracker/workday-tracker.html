<div
  class="workday-tracker-floating workday-tracker-container"
  [cdkDragDisabled]="dockingService.isFullscreen()"
  cdkDrag
  [cdkDragData]="{ type: 'workday-tracker' }"
  (cdkDragEnded)="onDragDropped($event)"
  (cdkDragStarted)="onDragStarted()"
  (cdkDragMoved)="onDragMoved($event)"
  cdkDragBoundary="body"
  cdkDragRootElement=".workday-tracker-floating"
  *ngIf="dockingService.isVisible()"
  [class.mobile-fullscreen]="dockingService.isFullscreen()"
>
  <!-- Header with Title and Controls -->
  <div class="tracker-header">
    <h2>Arbeitszeit-Tracker</h2>
    <div class="header-controls">
      <!-- Minimize Button (Desktop) -->
      <button 
        class="minimize-btn" 
        *ngIf="!dockingService.isMobile()"
        (click)="dockTracker()"
        title="In Navbar parken">
        <span>üì¶</span>
      </button>
      
      <!-- Close Button (Mobile Fullscreen) -->
      <button 
        class="close-btn" 
        *ngIf="dockingService.isMobile() && dockingService.isFullscreen()"
        (click)="closeFullscreen()"
        title="Schlie√üen">
        <span>‚úï</span>
      </button>
    </div>
  </div>
  
  <!-- Live Timer Display -->
  <div class="live-timer" [class.active]="trackerStatus === 'running' || trackerStatus === 'paused'">
    <div class="timer-display" [class]="'timer-' + trackerStatus">
      <span class="timer-label">
        {{ trackerStatus === 'running' ? 'üü¢ Arbeitszeit:' : 
           trackerStatus === 'paused' ? '‚è∏Ô∏è Pausenzeit:' : 
           '‚è±Ô∏è Timer:' }}
      </span>
      <span class="timer-value">{{ formatSessionTime() }}</span>
    </div>
  </div>

  <div class="workday-controls">
    <!-- Task Selection Section -->
    <div class="task-selection">
      <label for="task-dropdown">Task w√§hlen:</label>
      <div class="dropdown-container" [class.open]="dropdownOpen">
        <div
          class="dropdown-trigger"
          (click)="toggleDropdown()"
          [class.open]="dropdownOpen"
        >
          <span class="selected-value">
            {{ getSelectedTaskTitle() || 'Task ausw√§hlen...' }}
          </span>
        </div>

        <div class="dropdown-menu" *ngIf="dropdownOpen">
          <div
            class="dropdown-item"
            *ngFor="let task of tasks$ | async; trackBy: trackByTaskId"
            [class.selected]="task.id === selectedTaskId"
            (click)="selectTask(task.id, task.title)"
          >
            <span class="task-title">{{ task.title }}</span>
            <span class="task-status" [class]="'status-' + task.status"
              >{{ task.status }}</span
            >
          </div>

          <div
            class="dropdown-item no-tasks"
            *ngIf="(tasks$ | async)?.length === 0"
          >
            <span class="task-title">Keine Tasks verf√ºgbar</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Button Group -->
    <div class="button-group">
      <button
        (click)="startWorkday()"
        [disabled]="!selectedTaskId || trackerStatus !== 'idle'"
      >
        Start
      </button>
      <button (click)="pauseWorkday()" [disabled]="trackerStatus !== 'running'">
        Pause
      </button>
      <button (click)="resumeWorkday()" [disabled]="trackerStatus !== 'paused'">
        Weiter
      </button>
      <button
        (click)="stopWorkday()"
        [disabled]="!(trackerStatus === 'running' && hasPausedOnce)"
      >
        Stopp
      </button>
    </div>
  </div>
  <div class="workday-chart">
    <ng-container *ngIf="timeState$ | async as state">
      <div class="active-task">
        <span
          *ngIf="state.sections.length > 0 && state.sections[state.sections.length-1].type === 'work'"
        >
          Aktive Task:
          <strong
            >{{ getTaskTitle(state.sections[state.sections.length-1].taskId)
            }}</strong
          >
        </span>
      </div>
      <div class="chart-bar">
        <ng-container *ngFor="let section of state.sections; let i = index">
          <ng-container *ngIf="section.type === 'work'; else pauseBlock">
            <div
              class="chart-section work"
              [style.width.%]="sectionWidths[i]"
              [title]="getTaskTitle(section.taskId) + ' | ' + formatTime(section.start) + ' - ' + formatTime(section.end)"
            >
              <span class="chart-label" *ngIf="section.end">
                {{ getTaskTitle(section.taskId) }}<br />
                {{ formatTime(section.start) }} - {{ formatTime(section.end) }}
              </span>
            </div>
          </ng-container>
          <ng-template #pauseBlock>
            <div
              class="chart-section pause"
              [style.width.%]="sectionWidths[i]"
              [title]="'Pause | ' + formatTime(section.start) + ' - ' + formatTime(section.end)"
            >
              <span class="chart-label" *ngIf="section.end">
                Pause<br />
                {{ formatTime(section.start) }} - {{ formatTime(section.end) }}
              </span>
            </div>
          </ng-template>
        </ng-container>
      </div>
    </ng-container>
  </div>
</div>
